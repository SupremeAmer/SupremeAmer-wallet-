<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self'; 
                  script-src 'self' https://telegram.org https://cdn.jsdelivr.net; 
                  style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; 
                  img-src 'self' data: https://* blob:;">
    <title>SupremeAmer Token Mining</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css">
    <link rel="manifest" href="/manifest.json">
    <style>
        :root {
            --primary: #4e54c8;
            --secondary: #8f94fb;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --dark: #343a40;
            --light: #f8f9fa;
            --pro: #9c27b0;
            --enterprise: #ff5722;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            padding-bottom: 80px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .logo-img {
            height: 60px;
            width: auto;
        }
        
        .logo-text {
            color: var(--primary);
            font-weight: 700;
            font-size: 2.5rem;
            margin-bottom: 5px;
        }
        
        .tagline {
            color: var(--secondary);
            font-size: 1.1rem;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
            border: none;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        
        .card-body {
            padding: 25px;
        }
        
        .mining-animation {
            height: 150px;
            margin: 20px auto;
            position: relative;
            overflow: hidden;
            border-radius: 15px;
            background: linear-gradient(145deg, #e9ecef, #ffffff);
            box-shadow: inset 0 0 15px rgba(0,0,0,0.1);
        }
        
        .mining-rig-3d {
            display: flex;
            justify-content: space-around;
            position: absolute;
            bottom: 20px;
            width: 100%;
            perspective: 1000px;
        }
        
        .miner-3d {
            width: 50px;
            height: 50px;
            background: linear-gradient(145deg, #343a40, #4a525a);
            border-radius: 8px;
            position: relative;
            transform-style: preserve-3d;
            animation: mining-3d 3s infinite ease-in-out;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .miner-3d::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 10px;
            background: #212529;
            bottom: -10px;
            transform: rotateX(90deg);
            transform-origin: top;
        }
        
        @keyframes mining-3d {
            0%, 100% { transform: translateY(0) rotateX(0); }
            50% { transform: translateY(-25px) rotateX(30deg); }
        }
        
        .satoshis-falling {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .satoshis-falling::before {
            content: "SAT";
            position: absolute;
            top: -20px;
            left: 10%;
            animation: falling 3s linear infinite;
            color: var(--primary);
            font-weight: bold;
            font-size: 14px;
            text-shadow: 0 2px 3px rgba(0,0,0,0.2);
        }
        
        .satoshis-falling::after {
            content: "SAT";
            position: absolute;
            top: -20px;
            left: 30%;
            animation: falling 3.5s linear infinite 0.5s;
            color: var(--primary);
            font-weight: bold;
            font-size: 14px;
            text-shadow: 0 2px 3px rgba(0,0,0,0.2);
        }
        
        @keyframes falling {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(150px) rotate(360deg); opacity: 0; }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: var(--light);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .stat-label {
            display: block;
            font-size: 0.85rem;
            color: var(--dark);
            margin-bottom: 5px;
        }
        
        .stat-value {
            display: block;
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .btn {
            display: inline-block;
            border: none;
            border-radius: 50px;
            padding: 12px 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 1rem;
            margin: 5px 0;
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .btn:active::after {
            animation: ripple 0.6s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 1;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), #5cb85c);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #d9534f);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #f0ad4e);
            color: black;
        }
        
        .btn-info {
            background: linear-gradient(135deg, var(--info), #5bc0de);
            color: white;
        }
        
        .btn-pro {
            background: linear-gradient(135deg, var(--pro), #ba68c8);
            color: white;
        }
        
        .btn-enterprise {
            background: linear-gradient(135deg, var(--enterprise), #ff8a65);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        
        .btn-group .btn {
            flex: 1;
        }
        
        .input-group {
            display: flex;
            margin-bottom: 15px;
        }
        
        .form-control {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 50px 0 0 50px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            border-color: var(--primary);
        }
        
        .input-group-append .btn {
            border-radius: 0 50px 50px 0;
            margin-left: -1px;
            z-index: 1;
        }
        
        .footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: white;
            box-shadow: 0 -2px 15px rgba(0, 0, 0, 0.1);
            padding: 10px 0;
            z-index: 100;
        }
        
        .footer-nav {
            display: flex;
            justify-content: space-around;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .footer-btn {
            background: none;
            border: none;
            color: var(--dark);
            font-size: 1.5rem;
            padding: 5px 20px;
            border-radius: 50px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .footer-btn.active {
            color: var(--primary);
            transform: scale(1.1);
        }
        
        .footer-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 5px;
            height: 5px;
            background: var(--primary);
            border-radius: 50%;
        }
        
        .user-details {
            display: flex;
            align-items: center;
            margin-top: 15px;
            gap: 15px;
        }
        
        .user-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid var(--primary);
            object-fit: cover;
        }
        
        .wallet-address {
            font-family: monospace;
            font-size: 0.9rem;
            word-break: break-all;
            background: var(--light);
            padding: 8px 12px;
            border-radius: 5px;
            margin-top: 5px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-3 { margin-top: 15px; }
        .mb-3 { margin-bottom: 15px; }
        .my-3 { margin: 15px 0; }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            padding: 25px;
            transform: translateY(20px);
            transition: all 0.3s;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--dark);
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .tier-card {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .tier-card:hover {
            border-color: var(--primary);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .tier-card.selected {
            border-color: var(--primary);
            background: rgba(78, 84, 200, 0.05);
        }
        
        .tier-name {
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .tier-speed {
            color: var(--primary);
            font-weight: bold;
        }
        
        .tier-price {
            margin-top: 10px;
            font-weight: bold;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .logo-text {
                font-size: 2rem;
            }
            
            .logo-img {
                height: 50px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .mining-animation {
                height: 120px;
            }
            
            .miner-3d {
                width: 40px;
                height: 40px;
            }
        }
        
        @media (max-width: 480px) {
            .btn-group {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .logo-text {
                font-size: 1.8rem;
            }
            
            .logo-img {
                height: 40px;
            }
        }
        
        /* Animation for notification */
        @keyframes slideIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .notification {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            display: none;
        }
        
        /* Loading spinner */
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Badge for notifications */
        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- Notification System -->
    <div id="notification" class="notification"></div>
    
    <!-- Modal System -->
    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Modal Title</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                Modal content goes here
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary">Cancel</button>
                <button class="btn btn-primary">Confirm</button>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <img src="logo.png" alt="SupremeAmer Logo" class="logo-img">
            <div>
                <h1 class="logo-text">SupremeAmer</h1>
                <p class="tagline">Advanced Token Mining Platform</p>
            </div>
        </header>

        <div class="wallet-connect card">
            <div class="card-body">
                <button id="connectWallet" class="btn btn-primary btn-block">
                    <i class="fas fa-wallet"></i> Connect Wallet
                </button>
                <div id="walletAddress" class="mt-3 wallet-address hidden"></div>
            </div>
        </div>

        <div class="mining-card card">
            <div class="card-body text-center">
                <div class="mining-animation">
                    <div class="mining-rig-3d">
                        <div class="miner-3d"></div>
                        <div class="miner-3d"></div>
                        <div class="miner-3d"></div>
                    </div>
                    <div class="satoshis-falling"></div>
                </div>
                <h3>Mining SupremeAmer Tokens</h3>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-label">Mined SAT</span>
                        <span id="minedAmount" class="stat-value">0</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Mining Speed</span>
                        <span id="miningSpeed" class="stat-value">0.08/hr</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Referrals</span>
                        <span id="referralCount" class="stat-value">0/3</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Tier</span>
                        <span id="miningTier" class="stat-value">Basic</span>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button id="startMining" class="btn btn-success">
                        <i class="fas fa-play"></i> Start Mining
                    </button>
                    <button id="upgradeBtn" class="btn btn-warning">
                        <i class="fas fa-bolt"></i> Upgrade
                    </button>
                </div>
                
                <button id="withdraw" class="btn btn-info btn-block" disabled>
                    <i class="fas fa-coins"></i> Withdraw (Min 10,000 SAT)
                </button>
            </div>
        </div>

        <div class="referral-section card">
            <div class="card-body">
                <h4><i class="fas fa-users"></i> Referral Program</h4>
                <p>Invite friends and earn 10% of their mining rewards</p>
                <div class="input-group">
                    <input type="text" id="referralLink" class="form-control" readonly>
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary" id="copyReferral">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                </div>
                <div class="stats-grid my-3">
                    <div class="stat-card">
                        <span class="stat-label">Total Referrals</span>
                        <span id="totalReferrals" class="stat-value">0</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Referral Earnings</span>
                        <span id="referralEarnings" class="stat-value">0 SAT</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="referralChart"></canvas>
                </div>
            </div>
        </div>

        <div class="telegram-auth card" id="telegramAuth">
            <div class="card-body text-center">
                <h4><i class="fab fa-telegram"></i> Register with Telegram</h4>
                <p>Connect your Telegram account to start mining</p>
                <script async src="https://telegram.org/js/telegram-widget.js?19" 
                        data-telegram-login="supremeamer_mining_bot" 
                        data-size="large" 
                        data-onauth="onTelegramAuth(user)" 
                        data-request-access="write"></script>
            </div>
        </div>

        <div class="user-info card hidden" id="userInfo">
            <div class="card-body">
                <h4>Welcome, <span id="userName"></span></h4>
                <div class="user-details">
                    <img id="userPhoto" src="" class="user-photo">
                    <div>
                        <div>Telegram ID: <span id="userId"></span></div>
                        <div>Mining since: <span id="joinDate"></span></div>
                        <div>Account Tier: <span id="userTier">Basic</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="earnings-card card hidden" id="earningsCard">
            <div class="card-body">
                <h4><i class="fas fa-chart-line"></i> Earnings Overview</h4>
                <div class="chart-container">
                    <canvas id="earningsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-nav">
            <button class="footer-btn active" data-page="home">
                <i class="fas fa-home"></i> Home
                <span class="badge hidden" id="homeBadge"></span>
            </button>
            <button class="footer-btn" data-page="dapp">
                <i class="fas fa-rocket"></i> DAPP
                <span class="badge hidden" id="dappBadge"></span>
            </button>
            <button class="footer-btn" data-page="settings">
                <i class="fas fa-cog"></i> Settings
                <span class="badge hidden" id="settingsBadge"></span>
            </button>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
        // Enhanced Configuration
        const config = {
            miningTiers: {
                basic: { speed: 0.08, price: 0, name: "Basic" },
                advanced: { speed: 0.12, price: 2, name: "Advanced" },
                pro: { speed: 0.20, price: 5, name: "Pro" },
                enterprise: { speed: 0.35, price: 10, name: "Enterprise" }
            },
            minWithdraw: 10000,
            requiredReferrals: 3,
            upgradeWallet: "0xYourWalletAddress",
            contractAddress: "0xSupremeAmerContract",
            bnbRpcUrl: "https://bsc-dataseed.binance.org/",
            telegramBotName: "supremeamer_mining_bot",
            referralBonus: 0.10 // 10% of referred users' earnings
        };

        // Enhanced State Management
        let state = {
            mined: 0,
            mining: false,
            tier: 'basic',
            referrals: 0,
            referralEarnings: 0,
            startTime: null,
            lastUpdate: null,
            walletConnected: false,
            walletAddress: null,
            telegramUser: null,
            miningInterval: null,
            referralData: [],
            earningsData: [],
            charts: {}
        };

        // DOM Elements
        const elements = {
            minedAmount: document.getElementById('minedAmount'),
            miningSpeed: document.getElementById('miningSpeed'),
            referralCount: document.getElementById('referralCount'),
            miningTier: document.getElementById('miningTier'),
            startMining: document.getElementById('startMining'),
            upgradeBtn: document.getElementById('upgradeBtn'),
            withdraw: document.getElementById('withdraw'),
            referralLink: document.getElementById('referralLink'),
            copyReferral: document.getElementById('copyReferral'),
            totalReferrals: document.getElementById('totalReferrals'),
            referralEarnings: document.getElementById('referralEarnings'),
            telegramAuth: document.getElementById('telegramAuth'),
            userInfo: document.getElementById('userInfo'),
            userName: document.getElementById('userName'),
            userId: document.getElementById('userId'),
            userPhoto: document.getElementById('userPhoto'),
            joinDate: document.getElementById('joinDate'),
            userTier: document.getElementById('userTier'),
            connectWallet: document.getElementById('connectWallet'),
            walletAddress: document.getElementById('walletAddress'),
            earningsCard: document.getElementById('earningsCard'),
            notification: document.getElementById('notification'),
            modal: document.getElementById('modal'),
            modalTitle: document.querySelector('.modal-title'),
            modalBody: document.querySelector('.modal-body'),
            modalFooter: document.querySelector('.modal-footer')
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadState();
            setupEventListeners();
            updateUI();
            generateReferralLink();
            checkReferral();
            setupNavigation();
            
            if (state.mining) {
                startMining();
            }
            
            // Initialize charts
            initCharts();
            
            // Check if PWA is installed
            if (window.matchMedia('(display-mode: standalone)').matches) {
                console.log('Running as PWA');
            }
            
            // Register service worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            }
        });

        function setupEventListeners() {
            // Mining controls
            elements.startMining.addEventListener('click', toggleMining);
            elements.upgradeBtn.addEventListener('click', showUpgradeOptions);
            elements.withdraw.addEventListener('click', withdrawFunds);
            
            // Referral system
            elements.copyReferral.addEventListener('click', copyReferralLink);
            
            // Wallet connection
            elements.connectWallet.addEventListener('click', connectWallet);
            
            // Modal system
            document.querySelector('.modal-close').addEventListener('click', closeModal);
            
            // Handle clicks on modal footer buttons
            elements.modalFooter.addEventListener('click', function(e) {
                if (e.target.classList.contains('btn')) {
                    const action = e.target.dataset.action;
                    if (action) {
                        handleModalAction(action);
                    }
                    closeModal();
                }
            });
            
            // Handle window focus to update mining if tab was inactive
            window.addEventListener('focus', function() {
                if (state.mining) {
                    calculateMined();
                    updateUI();
                }
            });
        }

        function setupNavigation() {
            document.querySelectorAll('.footer-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const page = this.dataset.page;
                    navigateTo(page);
                });
            });
        }

        function navigateTo(page) {
            // In a single-page app, this would change views without reload
            // For this example, we'll just show/hide sections
            document.querySelectorAll('.footer-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show notification badge for demonstration
            if (page === 'dapp') {
                showBadge('dappBadge', '3');
            }
        }

        function showBadge(badgeId, content) {
            const badge = document.getElementById(badgeId);
            badge.textContent = content;
            badge.classList.remove('hidden');
        }

        function initCharts() {
            // Initialize referral chart
            const referralCtx = document.getElementById('referralChart').getContext('2d');
            state.charts.referral = new Chart(referralCtx, {
                type: 'bar',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Referral Signups',
                        data: [2, 5, 3, 7],
                        backgroundColor: 'rgba(78, 84, 200, 0.7)',
                        borderColor: 'rgba(78, 84, 200, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Initialize earnings chart
            const earningsCtx = document.getElementById('earningsChart').getContext('2d');
            state.charts.earnings = new Chart(earningsCtx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'SAT Earned',
                        data: [1200, 1900, 1700, 2500, 2200, 3000, 2800],
                        fill: true,
                        backgroundColor: 'rgba(78, 84, 200, 0.2)',
                        borderColor: 'rgba(78, 84, 200, 1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateCharts() {
            // Update charts with real data when available
            if (state.charts.referral) {
                state.charts.referral.data.datasets[0].data = [
                    Math.floor(Math.random() * 10),
                    Math.floor(Math.random() * 10),
                    Math.floor(Math.random() * 10),
                    Math.floor(Math.random() * 10)
                ];
                state.charts.referral.update();
            }
            
            if (state.charts.earnings) {
                state.charts.earnings.data.datasets[0].data = [
                    Math.floor(Math.random() * 5000),
                    Math.floor(Math.random() * 5000),
                    Math.floor(Math.random() * 5000),
                    Math.floor(Math.random() * 5000),
                    Math.floor(Math.random() * 5000),
                    Math.floor(Math.random() * 5000),
                    Math.floor(Math.random() * 5000)
                ];
                state.charts.earnings.update();
            }
        }

        function loadState() {
            const savedState = localStorage.getItem('supremeamerMiningState');
            if (savedState) {
                try {
                    const parsed = JSON.parse(savedState);
                    // Convert string dates back to numbers
                    if (parsed.startTime) parsed.startTime = parseInt(parsed.startTime);
                    if (parsed.lastUpdate) parsed.lastUpdate = parseInt(parsed.lastUpdate);
                    state = { ...state, ...parsed };
                } catch (e) {
                    console.error('Failed to parse saved state', e);
                    localStorage.removeItem('supremeamerMiningState');
                }
            }
        }

        function saveState() {
            // Don't save charts to localStorage
            const { charts, ...toSave } = state;
            localStorage.setItem('supremeamerMiningState', JSON.stringify(toSave));
        }

        function updateUI() {
            // Update mining stats
            elements.minedAmount.textContent = state.mined.toFixed(2);
            elements.miningSpeed.textContent = `${config.miningTiers[state.tier].speed}/hr`;
            elements.miningTier.textContent = config.miningTiers[state.tier].name;
            elements.referralCount.textContent = `${state.referrals}/${config.requiredReferrals}`;
            elements.totalReferrals.textContent = state.referrals;
            elements.referralEarnings.textContent = state.referralEarnings.toFixed(2);
            
            // Update mining button
            if (state.mining) {
                elements.startMining.innerHTML = '<i class="fas fa-stop"></i> Stop Mining';
                elements.startMining.classList.remove('btn-success');
                elements.startMining.classList.add('btn-danger');
            } else {
                elements.startMining.innerHTML = '<i class="fas fa-play"></i> Start Mining';
                elements.startMining.classList.add('btn-success');
                elements.startMining.classList.remove('btn-danger');
            }
            
            // Update withdraw button
            elements.withdraw.disabled = !(state.mined >= config.minWithdraw && 
                                         state.referrals >= config.requiredReferrals && 
                                         state.walletConnected);
            
            // Update user info if logged in
            if (state.telegramUser) {
                elements.telegramAuth.classList.add('hidden');
                elements.userInfo.classList.remove('hidden');
                elements.earningsCard.classList.remove('hidden');
                elements.userName.textContent = `${state.telegramUser.first_name} ${state.telegramUser.last_name || ''}`;
                elements.userId.textContent = state.telegramUser.id;
                elements.userPhoto.src = state.telegramUser.photo_url || 'https://via.placeholder.com/150';
                elements.joinDate.textContent = new Date(state.telegramUser.auth_date * 1000).toLocaleDateString();
                elements.userTier.textContent = config.miningTiers[state.tier].name;
            }
            
            // Update wallet info
            if (state.walletConnected) {
                elements.connectWallet.innerHTML = '<i class="fas fa-check-circle"></i> Connected';
                elements.connectWallet.classList.add('btn-success');
                elements.connectWallet.classList.remove('btn-primary');
                elements.walletAddress.textContent = shortenAddress(state.walletAddress);
                elements.walletAddress.classList.remove('hidden');
            }
            
            // Update upgrade button based on tier
            if (state.tier === 'enterprise') {
                elements.upgradeBtn.disabled = true;
                elements.upgradeBtn.innerHTML = '<i class="fas fa-crown"></i> Max Tier';
            } else {
                elements.upgradeBtn.disabled = false;
                elements.upgradeBtn.innerHTML = '<i class="fas fa-bolt"></i> Upgrade';
            }
            
            // Update charts with fresh data
            updateCharts();
        }

        function toggleMining() {
            if (!state.telegramUser) {
                showNotification('Please register with Telegram first');
                return;
            }
            
            state.mining = !state.mining;
            
            if (state.mining) {
                startMining();
                showNotification('Mining started successfully!');
            } else {
                stopMining();
                showNotification('Mining stopped');
            }
            
            saveState();
            updateUI();
        }

        function startMining() {
            if (!state.startTime) {
                state.startTime = Date.now();
            }
            state.lastUpdate = Date.now();
            state.mining = true;
            
            // Start mining interval
            if (state.miningInterval) {
                clearInterval(state.miningInterval);
            }
            
            state.miningInterval = setInterval(updateMining, 1000);
        }

        function stopMining() {
            state.mining = false;
            clearInterval(state.miningInterval);
            calculateMined();
        }

        function updateMining() {
            calculateMined();
            updateUI();
            
            // Occasionally show mining notifications
            if (Math.random() > 0.95) {
                const messages = [
                    "Mining SAT tokens...",
                    "Blocks processed successfully!",
                    "Hashrate stable at 250 KH/s",
                    "Found new SAT tokens!"
                ];
                showNotification(messages[Math.floor(Math.random() * messages.length)]);
            }
        }

        function calculateMined() {
            if (!state.mining || !state.lastUpdate) return;
            
            const now = Date.now();
            const elapsedHours = (now - state.lastUpdate) / (1000 * 60 * 60);
            const speed = config.miningTiers[state.tier].speed;
            const minedThisInterval = elapsedHours * speed;
            
            state.mined += minedThisInterval;
            state.lastUpdate = now;
            
            saveState();
        }

        function showUpgradeOptions() {
            if (!state.walletConnected) {
                showNotification('Please connect your wallet first');
                return;
            }
            
            openModal(
                'Upgrade Mining Tier',
                `
                <div class="tier-options">
                    <div class="tier-card ${state.tier === 'basic' ? 'selected' : ''}" data-tier="basic">
                        <div class="tier-name">Basic Tier</div>
                        <div>Speed: <span class="tier-speed">0.08 SAT/hr</span></div>
                        <div class="tier-price">Free</div>
                        ${state.tier === 'basic' ? '<i class="fas fa-check"></i> Current' : ''}
                    </div>
                    
                    <div class="tier-card ${state.tier === 'advanced' ? 'selected' : ''}" data-tier="advanced">
                        <div class="tier-name">Advanced Tier</div>
                        <div>Speed: <span class="tier-speed">0.12 SAT/hr</span></div>
                        <div class="tier-price">$${config.miningTiers.advanced.price} in BNB</div>
                        ${state.tier === 'advanced' ? '<i class="fas fa-check"></i> Current' : ''}
                    </div>
                    
                    <div class="tier-card ${state.tier === 'pro' ? 'selected' : ''}" data-tier="pro">
                        <div class="tier-name">Pro Tier</div>
                        <div>Speed: <span class="tier-speed">0.20 SAT/hr</span></div>
                        <div class="tier-price">$${config.miningTiers.pro.price} in BNB</div>
                        ${state.tier === 'pro' ? '<i class="fas fa-check"></i> Current' : ''}
                    </div>
                    
                    <div class="tier-card ${state.tier === 'enterprise' ? 'selected' : ''}" data-tier="enterprise">
                        <div class="tier-name">Enterprise Tier</div>
                        <div>Speed: <span class="tier-speed">0.35 SAT/hr</span></div>
                        <div class="tier-price">$${config.miningTiers.enterprise.price} in BNB</div>
                        ${state.tier === 'enterprise' ? '<i class="fas fa-check"></i> Current' : ''}
                    </div>
                </div>
                `,
                [
                    { text: 'Cancel', class: 'btn-secondary', action: 'cancel' },
                    { text: 'Upgrade', class: 'btn-primary', action: 'upgrade' }
                ]
            );
            
            // Add tier selection
            document.querySelectorAll('.tier-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('.tier-card').forEach(c => {
                        c.classList.remove('selected');
                    });
                    this.classList.add('selected');
                });
            });
        }

        function handleUpgrade(tier) {
            if (tier === state.tier) {
                showNotification('You already have this tier');
                return;
            }
            
            const tierInfo = config.miningTiers[tier];
            
            if (tierInfo.price > 0) {
                showModal(
                    'Confirm Upgrade',
                    `
                    <p>Upgrade to <strong>${tierInfo.name} Tier</strong> for <strong>${tierInfo.speed} SAT/hr</strong>?</p>
                    <p>Cost: <strong>$${tierInfo.price} worth of BNB</strong></p>
                    <p>This transaction will be sent to the blockchain.</p>
                    `,
                    [
                        { text: 'Cancel', class: 'btn-secondary', action: 'cancel' },
                        { text: 'Confirm & Pay', class: 'btn-primary', action: `confirmUpgrade:${tier}` }
                    ]
                );
            } else {
                // Free tier change
                state.tier = tier;
                saveState();
                updateUI();
                showNotification(`Switched to ${tierInfo.name} Tier`);
            }
        }

        function processUpgrade(tier) {
            showNotification('Processing upgrade transaction...', 3000);
            
            // Simulate blockchain transaction
            setTimeout(() => {
                state.tier = tier;
                saveState();
                updateUI();
                showNotification(`Upgraded to ${config.miningTiers[tier].name} Tier successfully!`);
            }, 3000);
        }

        function withdrawFunds() {
            if (!state.walletConnected) {
                showNotification('Please connect your wallet first');
                return;
            }
            
            if (state.mined < config.minWithdraw) {
                showNotification(`Minimum withdrawal is ${config.minWithdraw} SAT`);
                return;
            }
            
            if (state.referrals < config.requiredReferrals) {
                showNotification(`You need ${config.requiredReferrals} referrals to withdraw`);
                return;
            }
            
            openModal(
                'Confirm Withdrawal',
                `
                <p>You are about to withdraw <strong>${state.mined.toFixed(2)} SAT</strong> to your wallet:</p>
                <p class="wallet-address">${state.walletAddress}</p>
                <p>Network fee: <strong>0.001 BNB</strong></p>
                `,
                [
                    { text: 'Cancel', class: 'btn-secondary', action: 'cancel' },
                    { text: 'Confirm Withdrawal', class: 'btn-primary', action: 'confirmWithdraw' }
                ]
            );
        }

        function processWithdrawal() {
            showNotification('Processing withdrawal transaction...', 3000);
            
            // Simulate blockchain transaction
            setTimeout(() => {
                const withdrawn = state.mined;
                state.mined = 0;
                saveState();
                updateUI();
                showNotification(`Successfully withdrew ${withdrawn.toFixed(2)} SAT!`);
            }, 3000);
        }

        function generateReferralLink() {
            const baseUrl = window.location.href.split('?')[0];
            const refId = state.telegramUser ? state.telegramUser.id : 'ref';
            elements.referralLink.value = `${baseUrl}?ref=${refId}`;
        }

        function checkReferral() {
            const urlParams = new URLSearchParams(window.location.search);
            const refParam = urlParams.get('ref');
            
            if (refParam && refParam !== (state.telegramUser?.id || '')) {
                // Register referral (in a real app, you would verify this server-side)
                if (!localStorage.getItem(`ref_${refParam}`)) {
                    state.referrals += 1;
                    state.referralEarnings += 100; // Example bonus
                    localStorage.setItem(`ref_${refParam}`, 'registered');
                    saveState();
                    updateUI();
                    showNotification('Referral registered! +100 SAT bonus');
                }
            }
        }

        function copyReferralLink() {
            elements.referralLink.select();
            document.execCommand('copy');
            showNotification('Referral link copied to clipboard!');
        }

        function onTelegramAuth(user) {
            state.telegramUser = user;
            saveState();
            updateUI();
            generateReferralLink();
            showNotification('Successfully registered with Telegram!');
            
            // Simulate referral data
            setTimeout(() => {
                showBadge('homeBadge', '1');
            }, 2000);
        }

        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    throw new Error('No Ethereum provider detected. Please install MetaMask.');
                }
                
                // Show connecting state
                elements.connectWallet.innerHTML = '<span class="spinner"></span> Connecting...';
                
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                }).catch(err => {
                    if (err.code === 4001) {
                        throw new Error('Please connect your wallet to continue.');
                    }
                    throw err;
                });
                
                state.walletAddress = accounts[0];
                state.walletConnected = true;
                
                // Listen for account changes
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        // Wallet disconnected
                        state.walletConnected = false;
                        state.walletAddress = null;
                        showNotification('Wallet disconnected');
                    } else {
                        // Wallet changed
                        state.walletAddress = accounts[0];
                        showNotification('Wallet account changed');
                    }
                    saveState();
                    updateUI();
                });
                
                // Listen for chain changes
                window.ethereum.on('chainChanged', () => {
                    window.location.reload();
                });
                
                saveState();
                updateUI();
                showNotification('Wallet connected successfully!');
                
            } catch (error) {
                console.error('Wallet connection error:', error);
                elements.connectWallet.innerHTML = '<i class="fas fa-wallet"></i> Connect Wallet';
                
                openModal(
                    'Wallet Connection Failed',
                    `
                    <p>${error.message}</p>
                    ${!window.ethereum ? '<p>Would you like to install MetaMask?</p>' : ''}
                    `,
                    [
                        { text: 'Cancel', class: 'btn-secondary', action: 'cancel' },
                        ...(!window.ethereum ? [{ 
                            text: 'Install MetaMask', 
                            class: 'btn-primary', 
                            action: 'installMetamask' 
                        }] : [])
                    ]
                );
            }
        }

        function shortenAddress(address) {
            if (!address) return '';
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        }

        // Modal System Functions
        function openModal(title, content, buttons = []) {
            elements.modalTitle.textContent = title;
            elements.modalBody.innerHTML = content;
            
            // Clear existing buttons
            elements.modalFooter.innerHTML = '';
            
            // Add new buttons
            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.className = `btn ${btn.class}`;
                button.textContent = btn.text;
                if (btn.action) {
                    button.dataset.action = btn.action;
                }
                elements.modalFooter.appendChild(button);
            });
            
            elements.modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            elements.modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        function handleModalAction(action) {
            if (action === 'cancel') {
                // Do nothing
            } else if (action === 'installMetamask') {
                window.open('https://metamask.io', '_blank');
            } else if (action.startsWith('confirmUpgrade:')) {
                const tier = action.split(':')[1];
                processUpgrade(tier);
            } else if (action === 'confirmWithdraw') {
                processWithdrawal();
            }
        }

        // Notification System
        function showNotification(message, duration = 3000) {
            elements.notification.textContent = message;
            elements.notification.style.display = 'block';
            
            setTimeout(() => {
                elements.notification.style.display = 'none';
            }, duration);
        }

        // Expose Telegram auth function to global scope
        window.onTelegramAuth = onTelegramAuth;
        
        // Expose modal system for debugging
        window.showModal = openModal;
    </script>
</body>
</html>